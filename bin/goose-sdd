#/bin/bash

SELF_FPATH=$(realpath "$0");
SELF_DIR=$(dirname "$SELF_FPATH");
RECIPE_DIR=${SELF_DIR}/../recipes
PRJ_DIR=`pwd`
PRJ_NAME=`basename $PRJ_DIR`

GOOSE_SDD_DOCUMENT_PROVIDER=${GOOSE_SDD_DOCUMENT_PROVIDER:-$GOOSE_LEAD_PROVIDER}
GOOSE_SDD_DOCUMENT_PROVIDER=${GOOSE_SDD_DOCUMENT_PROVIDER:-$GOOSE_PROVIDER}
GOOSE_SDD_DOCUMENT_MODEL=${GOOSE_LEAD_MODEL:-$GOOSE_SDD_DOCUMENT_MODEL}
GOOSE_SDD_DOCUMENT_MODEL=${GOOSE_SDD_DOCUMENT_MODEL:-default}
GOOSE_SDD_CODING_PROVIDER=${GOOSE_SDD_CODING_PROVIDER:-$GOOSE_PROVIDER}
GOOSE_SDD_CODING_MODEL=${GOOSE_SDD_CODING_MODEL:-$GOOSE_SDD_DOCUMENT_MODEL}
GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"

tool() {
  command=$1
  shift

  case $command in
    ask | a)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      goose run $GOOSE_PROVIDER_MODEL --name "SDD Tool ask: $PRJ_NAME" --recipe $RECIPE_DIR/tool/spec-ask.yaml --interactive
      ;;
    help | h | *)
      echo '  ask(a): Product Consultant'
      echo '  help'
      ;;
  esac
}

system() {
  command=$1
  shift

  case $command in
    init | i)
      if [ -z $1 ]; then
        echo "Usage: system init <language>"
        return 1
      fi
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System init: $PRJ_NAME" --recipe "$RECIPE_DIR/system/spec-init.yaml" --params language="$1"
      ;;
    background | b)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System background: $PRJ_NAME" --interactive --recipe "$RECIPE_DIR/system/spec-background.yaml"
      ;;
    concept | c)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System concept: $PRJ_NAME" --interactive --recipe "$RECIPE_DIR/system/spec-concept.yaml"
      ;;
    architecture | a)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System architecture: $PRJ_NAME" --interactive --recipe "$RECIPE_DIR/system/spec-architecture.yaml"
      ;;
    rules | r)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System rules: $PRJ_NAME" --interactive --recipe "$RECIPE_DIR/system/spec-rules.yaml"
      ;;
    glossary | g)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System glossary: $PRJ_NAME" --interactive --recipe "$RECIPE_DIR/system/spec-glossary.yaml"
      ;;
    help | h | *)
      echo '  01. init(i)'
      echo '  02. background(b)'
      echo '  03. concept(t)'
      echo '  04. architecture(a)'
      echo '  05. rules(r)'
      echo '  05. glossary(g)'
      echo '      help'
      ;;
  esac
}

feature_goose_run() {
  command=$1
  shift
  if [ -z $command ]; then
    echo "Usage: feature $command <feature>"
    return 1
  fi

  feature_str=$1
  shift
  if [ -z $feature_str ]; then
    echo "Usage: feature $command <feature>"
    return 1
  fi

  goose_interactive=$1
  shift

  goose run $GOOSE_PROVIDER_MODEL --name "SDD Feature $command: $PRJ_NAME" $goose_interactive --recipe "$RECIPE_DIR/feature/spec-$command.yaml" --params feature="$feature_str"
}

feature_list() {
  FILE_NAME='00_feature.md'
  for dir_path in docs/sdd/*; do
    dir_name="$dir_path%/"
    target_file="$dir_path/$FILE_NAME"
    if [ -f "$target_file" ]; then
        content=$(cat "$target_file")
        echo "- $dir_name: $content"
    fi
  done
}

feature() {
  command=$1
  shift

  feature_str=$1
  shift

  case $command in
    init | i)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run init $feature_str
      ;;
    requirements | r)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run requirements $feature_str --interactive
      ;;
    design| d)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run design $feature_str --interactive
      ;;
    tests | t)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_CODING_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run tests $feature_str --interactive
      ;;
    code | c)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_CODING_PROVIDER --model $GOOSE_SDD_CODING_MODEL"
      feature_goose_run code $feature_str --interactive
      ;;
    list | l)
      feature_list
      ;;
    help | h | *)
      echo '  01. init(i) <feature text>'
      echo '  02. requirements(r) <feature>'
      echo '  03. design(d) <feature>'
      echo '  04. tests(t) <feature>'
      echo '  05. code(c) <feature>'
      echo '      help'
      ;;
  esac
}

mode=$1
shift
case $mode in
  --system | -s)
    system $*
    ;;
  --feature | -f)
    feature $1 $2
    ;;
  --tool | -t)
    tool $1
    ;;
  --version | -v)
    echo '0.0.9'
    ;;
  --help | -h | *)
    echo 'Options:'
    echo '--system(-s) <command>'
    system help
    echo '--feature(-f) <command>'
    feature help
    echo '--tool(-t) <command>'
    tool help
    ;;
esac
