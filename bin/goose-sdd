#/bin/bash

SELF_FPATH=$(realpath "$0");
SELF_DIR=$(dirname "$SELF_FPATH");
RECIPE_DIR=${SELF_DIR}/../recipes
PRJ_DIR=`pwd`
PRJ_NAME=`basename $PRJ_DIR`

GOOSE_SDD_DOCUMENT_PROVIDER=${GOOSE_SDD_DOCUMENT_PROVIDER:-$GOOSE_LEAD_PROVIDER}
GOOSE_SDD_DOCUMENT_PROVIDER=${GOOSE_SDD_DOCUMENT_PROVIDER:-$GOOSE_PROVIDER}
GOOSE_SDD_DOCUMENT_MODEL=${GOOSE_LEAD_MODEL:-$GOOSE_SDD_DOCUMENT_MODEL}
GOOSE_SDD_DOCUMENT_MODEL=${GOOSE_SDD_DOCUMENT_MODEL:-default}
GOOSE_SDD_CODING_PROVIDER=${GOOSE_SDD_CODING_PROVIDER:-$GOOSE_PROVIDER}
GOOSE_SDD_CODING_MODEL=${GOOSE_SDD_CODING_MODEL:-$GOOSE_SDD_DOCUMENT_MODEL}
GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"

USER_CONFIG_TOP=${XDG_CONFIG_HOME:-$HOME/.config}
USER_CONFIG_DIR="$USER_CONFIG_TOP/goose-sdd"
CONFIG_TOP=${XDG_CACHE_HOME:-$HOME/.cache}
CONFIG_DIR="$CONFIG_TOP/goose-sdd"

setup() {
  mkdir -p $USER_CONFIG_DIR/recipes
  mkdir -p $USER_CONFIG_DIR/recipes/system
  mkdir -p $USER_CONFIG_DIR/recipes/feature
  mkdir -p $USER_CONFIG_DIR/recipes/tool
  mkdir -p $CONFIG_DIR
  mkdir -p $CONFIG_DIR/recipes/system
  mkdir -p $CONFIG_DIR/recipes/feature
  mkdir -p $CONFIG_DIR/recipes/tool

  echo 'extensions:' > $USER_CONFIG_DIR/recipes/system/init.extention.yaml
  yq '.extensions' $RECIPE_DIR/system/init.yaml >> $USER_CONFIG_DIR/recipes/system/init.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/system/background.extention.yaml
  yq '.extensions' $RECIPE_DIR/system/background.yaml >> $USER_CONFIG_DIR/recipes/system/background.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/system/concept.extention.yaml
  yq '.extensions' $RECIPE_DIR/system/concept.yaml >> $USER_CONFIG_DIR/recipes/system/concept.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/system/architecture.extention.yaml
  yq '.extensions' $RECIPE_DIR/system/architecture.yaml >> $USER_CONFIG_DIR/recipes/system/architecture.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/system/rule.extention.yaml
  yq '.extensions' $RECIPE_DIR/system/rule.yaml >> $USER_CONFIG_DIR/recipes/system/rule.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/system/glossary.extention.yaml
  yq '.extensions' $RECIPE_DIR/system/glossary.yaml >> $USER_CONFIG_DIR/recipes/system/glossary.extention.yaml

  echo 'extensions:' > $USER_CONFIG_DIR/recipes/feature/init.extention.yaml
  yq '.extensions' $RECIPE_DIR/feature/init.yaml >> $USER_CONFIG_DIR/recipes/feature/init.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/feature/requirement.extention.yaml
  yq '.extensions' $RECIPE_DIR/feature/requirement.yaml >> $USER_CONFIG_DIR/recipes/feature/requirement.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/feature/design.extention.yaml
  yq '.extensions' $RECIPE_DIR/feature/design.yaml >> $USER_CONFIG_DIR/recipes/feature/design.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/feature/test.extention.yaml
  yq '.extensions' $RECIPE_DIR/feature/test.yaml >> $USER_CONFIG_DIR/recipes/feature/test.extention.yaml
  echo 'extensions:' > $USER_CONFIG_DIR/recipes/feature/code.extention.yaml
  yq '.extensions' $RECIPE_DIR/feature/code.yaml >> $USER_CONFIG_DIR/recipes/feature/code.extention.yaml

  echo 'extensions:' > $USER_CONFIG_DIR/recipes/tool/ask.extention.yaml
  yq '.extensions' $RECIPE_DIR/tool/ask.yaml >> $USER_CONFIG_DIR/recipes/tool/ask.extention.yaml
}

tool() {
  command=$1
  shift

  case $command in
    ask | a)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      extention_yaml=$USER_CONFIG_DIR/recipes/tool/ask.extention.yaml
      yq eval ".extensions += load(\"$extention_yaml\").extensions" $RECIPE_DIR/tool/ask.yaml > $CONFIG_DIR/recipes/tool/ask.yaml
      goose run $GOOSE_PROVIDER_MODEL --name "SDD Tool ask: $PRJ_NAME" --recipe $CONFIG_DIR/recipes/tool/ask.yaml --interactive
      ;;
    help | h | *)
      echo '  ask(a): Product Consultant'
      echo '  help'
      ;;
  esac
}

system() {
  command=$1
  shift

  extention_yaml=$USER_CONFIG_DIR/recipes/system/$command.extention.yaml
  yq eval ".extensions += load(\"$extention_yaml\").extensions" $RECIPE_DIR/system/$command.yaml > $CONFIG_DIR/recipes/system/$command.yaml
  case $command in
    init | i)
      if [ -z $1 ]; then
        echo "Usage: system init <language>"
        return 1
      fi
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System $command: $PRJ_NAME" --recipe "$CONFIG_DIR/recipes/system/$command.yaml" --params language="$1"
      ;;
    background | b)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System $command: $PRJ_NAME" --interactive --recipe "$CONFIG_DIR/recipes/system/$command.yaml"
      ;;
    concept | c)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System $command: $PRJ_NAME" --interactive --recipe "$CONFIG_DIR/recipes/system/$command.yaml"
      ;;
    architecture | a)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System $command: $PRJ_NAME" --interactive --recipe "$CONFIG_DIR/recipes/system/$command.yaml"
      ;;
    rule | r)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System $command: $PRJ_NAME" --interactive --recipe "$CONFIG_DIR/recipes/system/$command.yaml"
      ;;
    glossary | g)
      goose run $GOOSE_PROVIDER_MODEL --name "SDD System glossary: $PRJ_NAME" --interactive --recipe "$CONFIG_DIR/recipes/system/$command.yaml"
      ;;
    help | h | *)
      echo '  01. init(i)'
      echo '  02. background(b)'
      echo '  03. concept(t)'
      echo '  04. architecture(a)'
      echo '  05. rule(r)'
      echo '  05. glossary(g)'
      echo '      help'
      ;;
  esac
}

feature_goose_run() {
  command=$1
  shift
  if [ -z $command ]; then
    echo "Usage: feature $command <feature>"
    return 1
  fi

  feature_str=$1
  shift
  if [ -z $feature_str ]; then
    echo "Usage: feature $command <feature>"
    return 1
  fi

  goose_interactive=$1
  shift

  goose run $GOOSE_PROVIDER_MODEL --name "SDD Feature $command: $PRJ_NAME" $goose_interactive --recipe "$RECIPE_DIR/feature/$command.yaml" --params feature="$feature_str"
}

feature_list() {
  FILE_NAME='sdd.yaml'
  for dir_path in docs/sdd/*; do
    dir_name="$dir_path%/"
    target_file="$dir_path/$FILE_NAME"
    if [ -f "$target_file" ]; then
        content=$(cat "$target_file"|grep 'summary'|cut -d ':' -f2|cut -d ' ' -f2|sed 's/"//g')
        echo "- $dir_path: $content"
    fi
  done
}

feature() {
  command=$1
  shift

  feature_str=$1
  shift

  case $command in
    init | i)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run init $feature_str
      ;;
    requirement | r)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run requirement $feature_str --interactive
      ;;
    design| d)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_DOCUMENT_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run design $feature_str --interactive
      ;;
    test | t)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_CODING_PROVIDER --model $GOOSE_SDD_DOCUMENT_MODEL"
      feature_goose_run test $feature_str --interactive
      ;;
    code | c)
      GOOSE_PROVIDER_MODEL="--provider $GOOSE_SDD_CODING_PROVIDER --model $GOOSE_SDD_CODING_MODEL"
      feature_goose_run code $feature_str --interactive
      ;;
    list | l)
      feature_list
      ;;
    help | h | *)
      echo '  01. init(i) <feature text>'
      echo '  02. requirement(r) <feature>'
      echo '  03. design(d) <feature>'
      echo '  04. test(t) <feature>'
      echo '  05. code(c) <feature>'
      echo '      help'
      ;;
  esac
}

mode=$1
shift
case $mode in
  --setup)
    setup
    ;;
  --system | -s)
    system $*
    ;;
  --feature | -f)
    feature $1 $2
    ;;
  --tool | -t)
    tool $1
    ;;
  --version | -v)
    echo '0.0.11'
    ;;
  --help | -h | *)
    echo 'Options:'
    echo '--system(-s) <command>'
    system help
    echo '--feature(-f) <command>'
    feature help
    echo '--tool(-t) <command>'
    tool help
    ;;
esac
